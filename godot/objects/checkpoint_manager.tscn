[gd_scene load_steps=16 format=2]

[ext_resource path="res://resources/loop_meter_1.png" type="Texture" id=1]
[ext_resource path="res://resources/loop_meter_0.png" type="Texture" id=2]
[ext_resource path="res://resources/loop_light_Animation 1_2.png" type="Texture" id=3]
[ext_resource path="res://resources/loop_meter_2.png" type="Texture" id=4]
[ext_resource path="res://resources/loop_meter_3.png" type="Texture" id=5]
[ext_resource path="res://resources/loop_light_Animation 1_1.png" type="Texture" id=6]
[ext_resource path="res://resources/loop_light_Animation 1_0.png" type="Texture" id=7]
[ext_resource path="res://resources/loop_light_Animation 1_4.png" type="Texture" id=8]
[ext_resource path="res://resources/loop_light_Animation 1_7.png" type="Texture" id=9]
[ext_resource path="res://resources/loop_light_Animation 1_3.png" type="Texture" id=10]
[ext_resource path="res://resources/loop_light_Animation 1_5.png" type="Texture" id=11]
[ext_resource path="res://resources/loop_light_Animation 1_6.png" type="Texture" id=12]
[ext_resource path="res://objects/clickable.tscn" type="PackedScene" id=13]

[sub_resource type="GDScript" id=1]
script/source = "extends Node2D

export var next_level_manager: NodePath
export var camera: NodePath = \"../../camera\"

var per_loop: int
var touched: int
var expected: int

func _ready():
	var cc = []
	
	for c in get_children():
		var s = c.get_script()
		if not s: continue
		if s.resource_path.find(\"/checkpoint.tscn\") < 0: continue
		cc.append(c)

	assert(len(cc) > 1)
	
	per_loop = len(cc)
	expected = 3 * per_loop
	touched = 0

	for c in cc:
		c.set_state(\"red\")

	cc[0].set_state(\"green\")
	
	setup_visuals()


func setup_visuals():
	var loops = touched / per_loop
	if loops >= 3:
		$AnimatedSprite.playing = true
		$AnimatedSprite.visible = true
		$loop_meter_3.visible = true
		$loop_meter_2.visible = false
		$loop_meter_1.visible = false
		$loop_meter_0.visible = false
	elif loops >= 2:
		$AnimatedSprite.playing = false
		$AnimatedSprite.visible = false
		$loop_meter_3.visible = false
		$loop_meter_2.visible = true
		$loop_meter_1.visible = false
		$loop_meter_0.visible = false
	elif loops >= 1:
		$AnimatedSprite.playing = false
		$AnimatedSprite.visible = false
		$loop_meter_3.visible = false
		$loop_meter_2.visible = false
		$loop_meter_1.visible = true
		$loop_meter_0.visible = false
	elif loops >= 0:
		$AnimatedSprite.playing = false
		$AnimatedSprite.visible = false
		$loop_meter_3.visible = false
		$loop_meter_2.visible = false
		$loop_meter_1.visible = false
		$loop_meter_0.visible = true

func reset_touches():
	if (touched > 0):
		pass # TODO: Add effects, etc
	touched = 0
	setup_visuals()
	$clicker.enabled = false

func on_illegal_touch():
	if (touched >= expected):
		return # Forgivable
	reset_touches()

func on_player_action():
	if (touched >= expected):
		return # Forgivable
	reset_touches()

func on_touch_next():
	touched = touched + 1
	
	setup_visuals()
	
	if (touched >= expected):
		$clicker.enabled = true
	
	pass # TODO: Add effects (?)

func focus():
	touched = 0
	setup_visuals()

	get_node(camera).set_position(get_position())

func _on_clicker_clicked():
	get_node(next_level_manager).focus()
"

[sub_resource type="SpriteFrames" id=2]
animations = [ {
"frames": [ ExtResource( 7 ), ExtResource( 6 ), ExtResource( 3 ), ExtResource( 10 ), ExtResource( 8 ), ExtResource( 11 ), ExtResource( 12 ), ExtResource( 9 ) ],
"loop": true,
"name": "default",
"speed": 8.0
} ]

[node name="Node2D" type="Node2D"]
script = SubResource( 1 )

[node name="loop_meter_0" type="Sprite" parent="."]
texture = ExtResource( 2 )

[node name="loop_meter_1" type="Sprite" parent="."]
texture = ExtResource( 1 )

[node name="loop_meter_2" type="Sprite" parent="."]
texture = ExtResource( 4 )

[node name="loop_meter_3" type="Sprite" parent="."]
texture = ExtResource( 5 )

[node name="AnimatedSprite" type="AnimatedSprite" parent="."]
frames = SubResource( 2 )

[node name="clicker" parent="." instance=ExtResource( 13 )]
enabled = false
[connection signal="clicked" from="clicker" to="." method="_on_clicker_clicked"]
